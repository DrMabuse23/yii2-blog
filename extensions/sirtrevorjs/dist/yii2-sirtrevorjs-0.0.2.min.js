/*! yii2-sirtrevorjs 2014-07-19 */
(function(){var a=this,b=a._,c={},d=Array.prototype,e=Object.prototype,f=Function.prototype,g=d.push,h=d.slice,i=d.concat,j=e.toString,k=e.hasOwnProperty,l=d.forEach,m=d.map,n=d.reduce,o=d.reduceRight,p=d.filter,q=d.every,r=d.some,s=d.indexOf,t=d.lastIndexOf,u=Array.isArray,v=Object.keys,w=f.bind,x=function(a){return a instanceof x?a:this instanceof x?void(this._wrapped=a):new x(a)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):a._=x,x.VERSION="1.4.4";var y=x.each=x.forEach=function(a,b,d){if(null!=a)if(l&&a.forEach===l)a.forEach(b,d);else if(a.length===+a.length){for(var e=0,f=a.length;f>e;e++)if(b.call(d,a[e],e,a)===c)return}else for(var g in a)if(x.has(a,g)&&b.call(d,a[g],g,a)===c)return};x.map=x.collect=function(a,b,c){var d=[];return null==a?d:m&&a.map===m?a.map(b,c):(y(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)}),d)};var z="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),n&&a.reduce===n)return d&&(b=x.bind(b,d)),e?a.reduce(b,c):a.reduce(b);if(y(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)}),!e)throw new TypeError(z);return c},x.reduceRight=x.foldr=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),o&&a.reduceRight===o)return d&&(b=x.bind(b,d)),e?a.reduceRight(b,c):a.reduceRight(b);var f=a.length;if(f!==+f){var g=x.keys(a);f=g.length}if(y(a,function(h,i,j){i=g?g[--f]:--f,e?c=b.call(d,c,a[i],i,j):(c=a[i],e=!0)}),!e)throw new TypeError(z);return c},x.find=x.detect=function(a,b,c){var d;return A(a,function(a,e,f){return b.call(c,a,e,f)?(d=a,!0):void 0}),d},x.filter=x.select=function(a,b,c){var d=[];return null==a?d:p&&a.filter===p?a.filter(b,c):(y(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)}),d)},x.reject=function(a,b,c){return x.filter(a,function(a,d,e){return!b.call(c,a,d,e)},c)},x.every=x.all=function(a,b,d){b||(b=x.identity);var e=!0;return null==a?e:q&&a.every===q?a.every(b,d):(y(a,function(a,f,g){return(e=e&&b.call(d,a,f,g))?void 0:c}),!!e)};var A=x.some=x.any=function(a,b,d){b||(b=x.identity);var e=!1;return null==a?e:r&&a.some===r?a.some(b,d):(y(a,function(a,f,g){return e||(e=b.call(d,a,f,g))?c:void 0}),!!e)};x.contains=x.include=function(a,b){return null==a?!1:s&&a.indexOf===s?-1!=a.indexOf(b):A(a,function(a){return a===b})},x.invoke=function(a,b){var c=h.call(arguments,2),d=x.isFunction(b);return x.map(a,function(a){return(d?b:a[b]).apply(a,c)})},x.pluck=function(a,b){return x.map(a,function(a){return a[b]})},x.where=function(a,b,c){return x.isEmpty(b)?c?null:[]:x[c?"find":"filter"](a,function(a){for(var c in b)if(b[c]!==a[c])return!1;return!0})},x.findWhere=function(a,b){return x.where(a,b,!0)},x.max=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0]&&a.length<65535)return Math.max.apply(Math,a);if(!b&&x.isEmpty(a))return-1/0;var d={computed:-1/0,value:-1/0};return y(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g>=d.computed&&(d={value:a,computed:g})}),d.value},x.min=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0]&&a.length<65535)return Math.min.apply(Math,a);if(!b&&x.isEmpty(a))return 1/0;var d={computed:1/0,value:1/0};return y(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g<d.computed&&(d={value:a,computed:g})}),d.value},x.shuffle=function(a){var b,c=0,d=[];return y(a,function(a){b=x.random(c++),d[c-1]=d[b],d[b]=a}),d};var B=function(a){return x.isFunction(a)?a:function(b){return b[a]}};x.sortBy=function(a,b,c){var d=B(b);return x.pluck(x.map(a,function(a,b,e){return{value:a,index:b,criteria:d.call(c,a,b,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(d>c||void 0===d)return-1}return a.index<b.index?-1:1}),"value")};var C=function(a,b,c,d){var e={},f=B(b||x.identity);return y(a,function(b,g){var h=f.call(c,b,g,a);d(e,h,b)}),e};x.groupBy=function(a,b,c){return C(a,b,c,function(a,b,c){(x.has(a,b)?a[b]:a[b]=[]).push(c)})},x.countBy=function(a,b,c){return C(a,b,c,function(a,b){x.has(a,b)||(a[b]=0),a[b]++})},x.sortedIndex=function(a,b,c,d){c=null==c?x.identity:B(c);for(var e=c.call(d,b),f=0,g=a.length;g>f;){var h=f+g>>>1;c.call(d,a[h])<e?f=h+1:g=h}return f},x.toArray=function(a){return a?x.isArray(a)?h.call(a):a.length===+a.length?x.map(a,x.identity):x.values(a):[]},x.size=function(a){return null==a?0:a.length===+a.length?a.length:x.keys(a).length},x.first=x.head=x.take=function(a,b,c){return null==a?void 0:null==b||c?a[0]:h.call(a,0,b)},x.initial=function(a,b,c){return h.call(a,0,a.length-(null==b||c?1:b))},x.last=function(a,b,c){return null==a?void 0:null==b||c?a[a.length-1]:h.call(a,Math.max(a.length-b,0))},x.rest=x.tail=x.drop=function(a,b,c){return h.call(a,null==b||c?1:b)},x.compact=function(a){return x.filter(a,x.identity)};var D=function(a,b,c){return y(a,function(a){x.isArray(a)?b?g.apply(c,a):D(a,b,c):c.push(a)}),c};x.flatten=function(a,b){return D(a,b,[])},x.without=function(a){return x.difference(a,h.call(arguments,1))},x.uniq=x.unique=function(a,b,c,d){x.isFunction(b)&&(d=c,c=b,b=!1);var e=c?x.map(a,c,d):a,f=[],g=[];return y(e,function(c,d){(b?d&&g[g.length-1]===c:x.contains(g,c))||(g.push(c),f.push(a[d]))}),f},x.union=function(){return x.uniq(i.apply(d,arguments))},x.intersection=function(a){var b=h.call(arguments,1);return x.filter(x.uniq(a),function(a){return x.every(b,function(b){return x.indexOf(b,a)>=0})})},x.difference=function(a){var b=i.apply(d,h.call(arguments,1));return x.filter(a,function(a){return!x.contains(b,a)})},x.zip=function(){for(var a=h.call(arguments),b=x.max(x.pluck(a,"length")),c=new Array(b),d=0;b>d;d++)c[d]=x.pluck(a,""+d);return c},x.object=function(a,b){if(null==a)return{};for(var c={},d=0,e=a.length;e>d;d++)b?c[a[d]]=b[d]:c[a[d][0]]=a[d][1];return c},x.indexOf=function(a,b,c){if(null==a)return-1;var d=0,e=a.length;if(c){if("number"!=typeof c)return d=x.sortedIndex(a,b),a[d]===b?d:-1;d=0>c?Math.max(0,e+c):c}if(s&&a.indexOf===s)return a.indexOf(b,c);for(;e>d;d++)if(a[d]===b)return d;return-1},x.lastIndexOf=function(a,b,c){if(null==a)return-1;var d=null!=c;if(t&&a.lastIndexOf===t)return d?a.lastIndexOf(b,c):a.lastIndexOf(b);for(var e=d?c:a.length;e--;)if(a[e]===b)return e;return-1},x.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=arguments[2]||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=new Array(d);d>e;)f[e++]=a,a+=c;return f},x.bind=function(a,b){if(a.bind===w&&w)return w.apply(a,h.call(arguments,1));var c=h.call(arguments,2);return function(){return a.apply(b,c.concat(h.call(arguments)))}},x.partial=function(a){var b=h.call(arguments,1);return function(){return a.apply(this,b.concat(h.call(arguments)))}},x.bindAll=function(a){var b=h.call(arguments,1);return 0===b.length&&(b=x.functions(a)),y(b,function(b){a[b]=x.bind(a[b],a)}),a},x.memoize=function(a,b){var c={};return b||(b=x.identity),function(){var d=b.apply(this,arguments);return x.has(c,d)?c[d]:c[d]=a.apply(this,arguments)}},x.delay=function(a,b){var c=h.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},x.defer=function(a){return x.delay.apply(x,[a,1].concat(h.call(arguments,1)))},x.throttle=function(a,b){var c,d,e,f,g=0,h=function(){g=new Date,e=null,f=a.apply(c,d)};return function(){var i=new Date,j=b-(i-g);return c=this,d=arguments,0>=j?(clearTimeout(e),e=null,g=i,f=a.apply(c,d)):e||(e=setTimeout(h,j)),f}},x.debounce=function(a,b,c){var d,e;return function(){var f=this,g=arguments,h=function(){d=null,c||(e=a.apply(f,g))},i=c&&!d;return clearTimeout(d),d=setTimeout(h,b),i&&(e=a.apply(f,g)),e}},x.once=function(a){var b,c=!1;return function(){return c?b:(c=!0,b=a.apply(this,arguments),a=null,b)}},x.wrap=function(a,b){return function(){var c=[a];return g.apply(c,arguments),b.apply(this,c)}},x.compose=function(){var a=arguments;return function(){for(var b=arguments,c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},x.after=function(a,b){return 0>=a?b():function(){return--a<1?b.apply(this,arguments):void 0}},x.keys=v||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)x.has(a,c)&&(b[b.length]=c);return b},x.values=function(a){var b=[];for(var c in a)x.has(a,c)&&b.push(a[c]);return b},x.pairs=function(a){var b=[];for(var c in a)x.has(a,c)&&b.push([c,a[c]]);return b},x.invert=function(a){var b={};for(var c in a)x.has(a,c)&&(b[a[c]]=c);return b},x.functions=x.methods=function(a){var b=[];for(var c in a)x.isFunction(a[c])&&b.push(c);return b.sort()},x.extend=function(a){return y(h.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]}),a},x.pick=function(a){var b={},c=i.apply(d,h.call(arguments,1));return y(c,function(c){c in a&&(b[c]=a[c])}),b},x.omit=function(a){var b={},c=i.apply(d,h.call(arguments,1));for(var e in a)x.contains(c,e)||(b[e]=a[e]);return b},x.defaults=function(a){return y(h.call(arguments,1),function(b){if(b)for(var c in b)null==a[c]&&(a[c]=b[c])}),a},x.clone=function(a){return x.isObject(a)?x.isArray(a)?a.slice():x.extend({},a):a},x.tap=function(a,b){return b(a),a};var E=function(a,b,c,d){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;a instanceof x&&(a=a._wrapped),b instanceof x&&(b=b._wrapped);var e=j.call(a);if(e!=j.call(b))return!1;switch(e){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if("object"!=typeof a||"object"!=typeof b)return!1;for(var f=c.length;f--;)if(c[f]==a)return d[f]==b;c.push(a),d.push(b);var g=0,h=!0;if("[object Array]"==e){if(g=a.length,h=g==b.length)for(;g--&&(h=E(a[g],b[g],c,d)););}else{var i=a.constructor,k=b.constructor;if(i!==k&&!(x.isFunction(i)&&i instanceof i&&x.isFunction(k)&&k instanceof k))return!1;for(var l in a)if(x.has(a,l)&&(g++,!(h=x.has(b,l)&&E(a[l],b[l],c,d))))break;if(h){for(l in b)if(x.has(b,l)&&!g--)break;h=!g}}return c.pop(),d.pop(),h};x.isEqual=function(a,b){return E(a,b,[],[])},x.isEmpty=function(a){if(null==a)return!0;if(x.isArray(a)||x.isString(a))return 0===a.length;for(var b in a)if(x.has(a,b))return!1;return!0},x.isElement=function(a){return!(!a||1!==a.nodeType)},x.isArray=u||function(a){return"[object Array]"==j.call(a)},x.isObject=function(a){return a===Object(a)},y(["Arguments","Function","String","Number","Date","RegExp"],function(a){x["is"+a]=function(b){return j.call(b)=="[object "+a+"]"}}),x.isArguments(arguments)||(x.isArguments=function(a){return!(!a||!x.has(a,"callee"))}),"function"!=typeof/./&&(x.isFunction=function(a){return"function"==typeof a}),x.isFinite=function(a){return isFinite(a)&&!isNaN(parseFloat(a))},x.isNaN=function(a){return x.isNumber(a)&&a!=+a},x.isBoolean=function(a){return a===!0||a===!1||"[object Boolean]"==j.call(a)},x.isNull=function(a){return null===a},x.isUndefined=function(a){return void 0===a},x.has=function(a,b){return k.call(a,b)},x.noConflict=function(){return a._=b,this},x.identity=function(a){return a},x.times=function(a,b,c){for(var d=Array(a),e=0;a>e;e++)d[e]=b.call(c,e);return d},x.random=function(a,b){return null==b&&(b=a,a=0),a+Math.floor(Math.random()*(b-a+1))};var F={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};F.unescape=x.invert(F.escape);var G={escape:new RegExp("["+x.keys(F.escape).join("")+"]","g"),unescape:new RegExp("("+x.keys(F.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(a){x[a]=function(b){return null==b?"":(""+b).replace(G[a],function(b){return F[a][b]})}}),x.result=function(a,b){if(null==a)return null;var c=a[b];return x.isFunction(c)?c.call(a):c},x.mixin=function(a){y(x.functions(a),function(b){var c=x[b]=a[b];x.prototype[b]=function(){var a=[this._wrapped];return g.apply(a,arguments),L.call(this,c.apply(x,a))}})};var H=0;x.uniqueId=function(a){var b=++H+"";return a?a+b:b},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var I=/(.)^/,J={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},K=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(a,b,c){var d;c=x.defaults({},c,x.templateSettings);var e=new RegExp([(c.escape||I).source,(c.interpolate||I).source,(c.evaluate||I).source].join("|")+"|$","g"),f=0,g="__p+='";a.replace(e,function(b,c,d,e,h){return g+=a.slice(f,h).replace(K,function(a){return"\\"+J[a]}),c&&(g+="'+\n((__t=("+c+"))==null?'':_.escape(__t))+\n'"),d&&(g+="'+\n((__t=("+d+"))==null?'':__t)+\n'"),e&&(g+="';\n"+e+"\n__p+='"),f=h+b.length,b}),g+="';\n",c.variable||(g="with(obj||{}){\n"+g+"}\n"),g="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+g+"return __p;\n";try{d=new Function(c.variable||"obj","_",g)}catch(h){throw h.source=g,h}if(b)return d(b,x);var i=function(a){return d.call(this,a,x)};return i.source="function("+(c.variable||"obj")+"){\n"+g+"}",i},x.chain=function(a){return x(a).chain()};var L=function(a){return this._chain?x(a).chain():a};x.mixin(x),y(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=d[a];x.prototype[a]=function(){var c=this._wrapped;return b.apply(c,arguments),"shift"!=a&&"splice"!=a||0!==c.length||delete c[0],L.call(this,c)}}),y(["concat","join","slice"],function(a){var b=d[a];x.prototype[a]=function(){return L.call(this,b.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this),function(a,b){if("function"==typeof define&&define.amd)define("eventable",["underscore"],function(c){return a.Eventable=b(c)});else if("undefined"!=typeof exports){var c=require("underscore");module.exports=b(c)}else a.Eventable=b(a._)}(this,function(a){var b=[],c=b.slice,d={on:function(a,b,c){if(!f(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(b,c,d){if(!f(this,"once",b,[c,d])||!c)return this;var e=this,g=a.once(function(){e.off(b,g),c.apply(this,arguments)});return g._callback=c,this.on(b,g,d)},off:function(b,c,d){var e,g,h,i,j,k,l,m;if(!this._events||!f(this,"off",b,[c,d]))return this;if(!b&&!c&&!d)return this._events={},this;for(i=b?[b]:a.keys(this._events),j=0,k=i.length;k>j;j++)if(b=i[j],h=this._events[b]){if(this._events[b]=e=[],c||d)for(l=0,m=h.length;m>l;l++)g=h[l],(c&&c!==g.callback&&c!==g.callback._callback||d&&d!==g.context)&&e.push(g);e.length||delete this._events[b]}return this},trigger:function(a){if(!this._events)return this;var b=c.call(arguments,1);if(!f(this,"trigger",a,b))return this;var d=this._events[a],e=this._events.all;return d&&g(d,b),e&&g(e,arguments),this},stopListening:function(a,b,c){var d=this._listeners;if(!d)return this;var e=!b&&!c;"object"==typeof b&&(c=this),a&&((d={})[a._listenerId]=a);for(var f in d)d[f].off(b,c,this),e&&delete this._listeners[f];return this}},e=/\s+/,f=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var f in c)a[b].apply(a,[f,c[f]].concat(d));return!1}if(e.test(c)){for(var g=c.split(e),h=0,i=g.length;i>h;h++)a[b].apply(a,[g[h]].concat(d));return!1}return!0},g=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}},h={listenTo:"on",listenToOnce:"once"};return a.each(h,function(b,c){d[c]=function(c,d,e){var f=this._listeners||(this._listeners={}),g=c._listenerId||(c._listenerId=a.uniqueId("l"));return f[g]=c,"object"==typeof d&&(e=this),c[b](d,e,this),this}}),d.bind=d.on,d.unbind=d.off,d}),function(a,b){function c(b){return b instanceof a?b:a(b)}var d,e=this;d=e.SirTrevor={},d.DEBUG=!1,d.SKIP_VALIDATION=!1,d.version="0.3.0",d.LANGUAGE="en",d.DEFAULTS={defaultType:!1,spinner:{className:"st-spinner",lines:9,length:8,width:3,radius:6,color:"#000",speed:1.4,trail:57,shadow:!1,left:"50%",top:"50%"},blockLimit:0,blockTypeLimits:{},required:[],uploadUrl:"/attachments",baseImageUrl:"/sir-trevor-uploads/",errorsContainer:void 0},d.BlockMixins={},d.Blocks={},d.Formatters={},d.instances=[],d.Events=Eventable;var f=!1,g={bound:[],_bindFunctions:function(){this.bound.length>0&&b.bindAll.apply(null,b.union([this],this.bound))}},h={tagName:"div",className:"sir-trevor__view",attributes:{},$:function(a){return this.$el.find(a)},render:function(){return this},destroy:function(){b.isUndefined(this.stopListening)||this.stopListening(),this.$el.remove()},_ensureElement:function(){if(this.el)this._setElement(this.el);else{var c,d=b.extend({},b.result(this,"attributes"));this.id&&(d.id=this.id),this.className&&(d["class"]=this.className),d.html&&(c=d.html,delete d.html);var e=a("<"+this.tagName+">").attr(d);c&&e.html(c),this._setElement(e)}},_setElement:function(a){return this.$el=c(a),this.el=this.$el[0],this}};!function(a){function b(a){a.preventDefault()}function c(b){b.originalEvent.dataTransfer.dropEffect="copy",a(b.currentTarget).addClass("st-drag-over"),b.preventDefault()}function d(b){a(b.currentTarget).removeClass("st-drag-over"),b.preventDefault()}a.fn.dropArea=function(){return this.bind("dragenter",b).bind("dragover",c).bind("dragleave",d),this},a.fn.noDropArea=function(){return this.unbind("dragenter").unbind("dragover").unbind("dragleave"),this},a.fn.caretToEnd=function(){var a,b;return a=document.createRange(),a.selectNodeContents(this[0]),a.collapse(!1),b=window.getSelection(),b.removeAllRanges(),b.addRange(a),this}}(jQuery);var i=function(a,c){var d,e=this;d=a&&b.has(a,"constructor")?a.constructor:function(){return e.apply(this,arguments)},b.extend(d,e,c);var f=function(){this.constructor=d};return f.prototype=e.prototype,d.prototype=new f,a&&b.extend(d.prototype,a),d.__super__=e.prototype,d};d.log=function(a){!b.isUndefined(console)&&d.DEBUG&&console.log(a)},d.Locales={en:{general:{"delete":"Delete?",drop:"Drag __block__ here",paste:"Or paste URL here",upload:"...or choose a file",close:"close",position:"Position",wait:"Please wait...",link:"Enter a link"},errors:{title:"You have the following errors:",validation_fail:"__type__ block is invalid",block_empty:"__name__ must not be empty",type_missing:"You must have a block of type __type__",required_type_empty:"A required block type __type__ is empty",load_fail:"There was a problem loading the contents of the document"},blocks:{text:{title:"Text"},columns:{title:"Columns"},list:{title:"List"},quote:{title:"Quote",credit_field:"Credit"},image:{title:"Image",upload_error:"There was a problem with your upload"},video:{title:"Video"},tweet:{title:"Tweet",fetch_error:"There was a problem fetching your tweet"},embedly:{title:"Embedly",fetch_error:"There was a problem fetching your embed",key_missing:"An Embedly API key must be present"},heading:{title:"Heading"}}}},void 0===window.i18n||void 0===window.i18n.init?(d.log("Using i18n stub"),window.i18n={t:function(a,c){var e,f,g,h,i=a.split(":");for(f=d.Locales[d.LANGUAGE],h=0;h<i.length;h++)g=i[h],b.isUndefined(f[g])||(f=f[g]);return e=f,b.isString(e)?(e.indexOf("__")>=0&&b.each(c,function(a,b){e=e.replace("__"+b+"__",a)}),e):""}}):(d.log("Using i18next"),i18n.init({resStore:d.Locales,fallbackLng:d.LANGUAGE,ns:{namespaces:["general","blocks"],defaultNs:"general"}})),function(a,b,c){function d(a,c){var d,e=b.createElement(a||"div");for(d in c)e[d]=c[d];return e}function e(a){for(var b=1,c=arguments.length;c>b;b++)a.appendChild(arguments[b]);return a}function f(a,b,c,d){var e=["opacity",b,~~(100*a),c,d].join("-"),f=.01+c/d*100,g=Math.max(1-(1-a)/b*(100-f),a),h=k.substring(0,k.indexOf("Animation")).toLowerCase(),i=h&&"-"+h+"-"||"";return m[e]||(n.insertRule("@"+i+"keyframes "+e+"{0%{opacity:"+g+"}"+f+"%{opacity:"+a+"}"+(f+.01)+"%{opacity:1}"+(f+b)%100+"%{opacity:"+a+"}100%{opacity:"+g+"}}",0),m[e]=1),e}function g(a,b){var d,e,f=a.style;if(f[b]!==c)return b;for(b=b.charAt(0).toUpperCase()+b.slice(1),e=0;e<l.length;e++)if(d=l[e]+b,f[d]!==c)return d}function h(a,b){for(var c in b)a.style[g(a,c)||c]=b[c];return a}function i(a){for(var b=1;b<arguments.length;b++){var d=arguments[b];for(var e in d)a[e]===c&&(a[e]=d[e])}return a}function j(a){for(var b={x:a.offsetLeft,y:a.offsetTop};a=a.offsetParent;)b.x+=a.offsetLeft,b.y+=a.offsetTop;return b}var k,l=["webkit","Moz","ms","O"],m={},n=function(){var a=d("style");return e(b.getElementsByTagName("head")[0],a),a.sheet||a.styleSheet}(),o={lines:12,length:7,width:5,radius:10,rotate:0,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto"},p=function q(a){return this.spin?void(this.opts=i(a||{},q.defaults,o)):new q(a)};p.defaults={},i(p.prototype,{spin:function(a){this.stop();var b,c,e=this,f=e.opts,g=e.el=h(d(0,{className:f.className}),{position:"relative",zIndex:f.zIndex}),i=f.radius+f.length+f.width;if(a&&(a.insertBefore(g,a.firstChild||null),c=j(a),b=j(g),h(g,{left:("auto"==f.left?c.x-b.x+(a.offsetWidth>>1):f.left+i)+"px",top:("auto"==f.top?c.y-b.y+(a.offsetHeight>>1):f.top+i)+"px"})),g.setAttribute("aria-role","progressbar"),e.lines(g,e.opts),!k){var l=0,m=f.fps,n=m/f.speed,o=(1-f.opacity)/(n*f.trail/100),p=n/f.lines;!function q(){l++;for(var a=f.lines;a;a--){var b=Math.max(1-(l+a*p)%n*o,f.opacity);e.opacity(g,f.lines-a,b,f)}e.timeout=e.el&&setTimeout(q,~~(1e3/m))}()}return e},stop:function(){var a=this.el;return a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=c),this},lines:function(a,b){function c(a,c){return h(d(),{position:"absolute",width:b.length+b.width+"px",height:b.width+"px",background:a,boxShadow:c,transformOrigin:"left",transform:"rotate("+~~(360/b.lines*i+b.rotate)+"deg) translate("+b.radius+"px,0)",borderRadius:(b.width>>1)+"px"})}for(var g,i=0;i<b.lines;i++)g=h(d(),{position:"absolute",top:1+~(b.width/2)+"px",transform:b.hwaccel?"translate3d(0,0,0)":"",opacity:b.opacity,animation:k&&f(b.opacity,b.trail,i,b.lines)+" "+1/b.speed+"s linear infinite"}),b.shadow&&e(g,h(c("#000","0 0 4px #000"),{top:"2px"})),e(a,e(g,c(b.color,"0 0 1px rgba(0,0,0,.1)")));return a},opacity:function(a,b,c){b<a.childNodes.length&&(a.childNodes[b].style.opacity=c)}}),!function(){function a(a,b){return d("<"+a+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',b)}var b=h(d("group"),{behavior:"url(#default#VML)"});!g(b,"transform")&&b.adj?(n.addRule(".spin-vml","behavior:url(#default#VML)"),p.prototype.lines=function(b,c){function d(){return h(a("group",{coordsize:j+" "+j,coordorigin:-i+" "+-i}),{width:j,height:j})}function f(b,f,g){e(l,e(h(d(),{rotation:360/c.lines*b+"deg",left:~~f}),e(h(a("roundrect",{arcsize:1}),{width:i,height:c.width,left:c.radius,top:-c.width>>1,filter:g}),a("fill",{color:c.color,opacity:c.opacity}),a("stroke",{opacity:0}))))}var g,i=c.length+c.width,j=2*i,k=2*-(c.width+c.length)+"px",l=h(d(),{position:"absolute",top:k,left:k});if(c.shadow)for(g=1;g<=c.lines;g++)f(g,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(g=1;g<=c.lines;g++)f(g);return e(b,l)},p.prototype.opacity=function(a,b,c,d){var e=a.firstChild;d=d.shadow&&d.lines||0,e&&b+d<e.childNodes.length&&(e=e.childNodes[b+d],e=e&&e.firstChild,e=e&&e.firstChild,e&&(e.opacity=c))}):k=g(b,"animation")}(),a.Spinner=p}(window,document),d.editorStore=function(a,c,e){var f;switch(e=e||{},c){case"create":var g=b.trim(a.$el.val());if(a.dataStore={data:[]},g.length>0)try{var h=JSON.parse(g);b.isUndefined(h.data)||(a.dataStore=h)}catch(i){a.errors.push({text:i18n.t("errors:load_fail")}),a.renderErrors(),d.log("Sorry there has been a problem with parsing the JSON"),d.log(i)}break;case"reset":a.dataStore={data:[]};break;case"add":e.data&&(a.dataStore.data.push(e.data),f=a.dataStore);break;case"save":a.$el.val(a.dataStore.data.length>0?JSON.stringify(a.dataStore):"");break;case"read":f=a.dataStore}return f?f:void 0},d.Submittable=function(a){this.$form=a,this.intialize()},b.extend(d.Submittable.prototype,{intialize:function(){this.$submitBtn=this.$form.find("input[type='submit']");var c=[];b.each(this.$submitBtn,function(b){c.push(a(b).attr("value"))}),this.submitBtnTitles=c,this.canSubmit=!0,this.globalUploadCount=0,this._bindEvents()},setSubmitButton:function(a,b){this.$submitBtn.attr("value",b)},resetSubmitButton:function(){b.each(this.$submitBtn,function(b,c){a(b).attr("value",this.submitBtnTitles[c])},this)},onUploadStart:function(){this.globalUploadCount++,d.log("onUploadStart called "+this.globalUploadCount),1===this.globalUploadCount&&this._disableSubmitButton()},onUploadStop:function(){this.globalUploadCount=this.globalUploadCount<=0?0:this.globalUploadCount-1,d.log("onUploadStop called "+this.globalUploadCount),0===this.globalUploadCount&&this._enableSubmitButton()},onError:function(){d.log("onError called"),this.canSubmit=!1},_disableSubmitButton:function(a){this.setSubmitButton(null,a||i18n.t("general:wait")),this.$submitBtn.attr("disabled","disabled").addClass("disabled")},_enableSubmitButton:function(){this.resetSubmitButton(),this.$submitBtn.removeAttr("disabled").removeClass("disabled")},_events:{disableSubmitButton:"_disableSubmitButton",enableSubmitButton:"_enableSubmitButton",setSubmitButton:"setSubmitButton",resetSubmitButton:"resetSubmitButton",onError:"onError",onUploadStart:"onUploadStart",onUploadStop:"onUploadStop"},_bindEvents:function(){b.forEach(this._events,function(a,b){d.EventBus.on(b,this[a],this)},this)}}),d.fileUploader=function(c,e,f,g){var h=[c.blockID,(new Date).getTime(),"raw"].join("-"),i=new FormData;i.append("attachment[name]",e.name),i.append("attachment[file]",e),i.append("attachment[uid]",h),c.resetMessages();var j=function(a){d.log("Upload callback called"),!b.isUndefined(f)&&b.isFunction(f)&&b.bind(f,c)(a)},k=function(a,e){d.log("Upload callback error called"),!b.isUndefined(g)&&b.isFunction(g)&&b.bind(g,c)(e)},l=a.ajax({url:d.DEFAULTS.uploadUrl,data:i,cache:!1,contentType:!1,processData:!1,dataType:"json",type:"POST"});return c.addQueuedItem(h,l),l.done(j).fail(k).always(b.bind(c.removeQueuedItem,c,h)),l};var j=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;b.mixin({isURI:function(a){return j.test(a)},titleize:function(a){return null===a?"":(a=String(a).toLowerCase(),a.replace(/(?:^|\s|-)\S/g,function(a){return a.toUpperCase()}))},classify:function(a){return b.titleize(String(a).replace(/[\W_]/g," ")).replace(/\s/g,"")},classifyList:function(a){return b.map(a,function(a){return b.classify(a)})},capitalize:function(a){return a.charAt(0).toUpperCase()+a.substring(1).toLowerCase()},underscored:function(a){return b.trim(a).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},trim:function(a){return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},reverse:function(a){return a.split("").reverse().join("")},flattern:function(a){var c={};return b.each(a,function(d,e){c[b.isArray(a)?d:e]=!0}),c},to_slug:function(a){return a.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}}),d.toHTML=function(a,c){c=b.classify(c);var e=a,f="Text"===c;b.isUndefined(f)&&(f=!1),f&&(e="<div>"+e),e=e.replace(/\[([^\]]+)\]\(([^\)]+)\)/gm,function(a,b,c){return"<a href='"+c+"'>"+b.replace(/\r?\n/g,"")+"</a>"}),e=b.reverse(b.reverse(e).replace(/_(?!\\)((_\\|[^_])*)_(?=$|[^\\])/gm,function(a,b){return">i/<"+b.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">i<"}).replace(/\*\*(?!\\)((\*\*\\|[^\*\*])*)\*\*(?=$|[^\\])/gm,function(a,b){return">b/<"+b.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">b<"})),e=e.replace(/^\> (.+)$/gm,"$1");var g,h;for(g in d.Formatters)d.Formatters.hasOwnProperty(g)&&(h=d.Formatters[g],!b.isUndefined(h.toHTML)&&b.isFunction(h.toHTML)&&(e=h.toHTML(e)));var i;return d.Blocks.hasOwnProperty(c)&&(i=d.Blocks[c],!b.isUndefined(i.prototype.toHTML)&&b.isFunction(i.prototype.toHTML)&&(e=i.prototype.toHTML(e))),f&&(e=e.replace(/\r?\n\r?\n/gm,"</div><div><br></div><div>"),e=e.replace(/\r?\n/gm,"</div><div>")),e=e.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/\r?\n/g,"<br>").replace(/\*\*/,"").replace(/__/,""),e=e.replace(/\\\*/g,"*").replace(/\\\[/g,"[").replace(/\\\]/g,"]").replace(/\\\_/g,"_").replace(/\\\(/g,"(").replace(/\\\)/g,")").replace(/\\\-/g,"-"),f&&(e+="</div>"),e},d.toMarkdown=function(a,c){function e(a,c,d){return b.isUndefined(d)&&(d=""),"**"+c.replace(/<(.)?br(.)?>/g,"")+"**"+d}function f(a,c,d){return b.isUndefined(d)&&(d=""),"_"+c.replace(/<(.)?br(.)?>/g,"")+"_"+d}c=b.classify(c);var g=a;g=g.replace(/&nbsp;/g," "),g=g.replace(/( class=(")?Mso[a-zA-Z]+(")?)/g,"").replace(/<!--(.*?)-->/g,"").replace(/\/\*(.*?)\*\//g,"").replace(/<(\/)*(meta|link|span|\\?xml:|st1:|o:|font)(.*?)>/gi,"");var h,i,j=["style","script","applet","embed","noframes","noscript"];for(i=0;i<j.length;i++)h=new RegExp("<"+j[i]+".*?"+j[i]+"(.*?)>","gi"),g=g.replace(h,"");g=g.replace(/\*/g,"\\*").replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\_/g,"\\_").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\-/g,"\\-");var k=["em","i","strong","b"];for(i=0;i<k.length;i++)h=new RegExp("<"+k[i]+"><br></"+k[i]+">","gi"),g=g.replace(h,"<br>");g=g.replace(/<(\w+)(?:\s+\w+="[^"]+(?:"\$[^"]+"[^"]+)?")*>\s*<\/\1>/gim,"").replace(/\n/gm,"").replace(/<a.*?href=[""'](.*?)[""'].*?>(.*?)<\/a>/gim,function(a,b,c){return"["+c.trim().replace(/<(.)?br(.)?>/g,"")+"]("+b+")"}).replace(/<strong>(?:\s*)(.*?)(\s)*?<\/strong>/gim,e).replace(/<b>(?:\s*)(.*?)(\s*)?<\/b>/gim,e).replace(/<em>(?:\s*)(.*?)(\s*)?<\/em>/gim,f).replace(/<i>(?:\s*)(.*?)(\s*)?<\/i>/gim,f);var l,m;for(l in d.Formatters)d.Formatters.hasOwnProperty(l)&&(m=d.Formatters[l],!b.isUndefined(m.toMarkdown)&&b.isFunction(m.toMarkdown)&&(g=m.toMarkdown(g)));g=g.replace(/([^<>]+)(<div>)/g,"$1\n$2").replace(/<div><div>/g,"\n<div>").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n").replace(/<\/p>/g,"\n\n").replace(/<(.)?br(.)?>/g,"\n").replace(/&lt;/g,"<").replace(/&gt;/g,">");var n;return d.Blocks.hasOwnProperty(c)&&(n=d.Blocks[c],!b.isUndefined(n.prototype.toMarkdown)&&b.isFunction(n.prototype.toMarkdown)&&(g=n.prototype.toMarkdown(g))),g=g.replace(/<\/?[^>]+(>|$)/g,"")},d.EventBus=b.extend({},d.Events),d.BlockMixins.Ajaxable={mixinName:"Ajaxable",ajaxable:!0,initializeAjaxable:function(){this._queued=[]},addQueuedItem:function(a,b){d.log("Adding queued item for "+this.blockID+" called "+a),d.EventBus.trigger("onUploadStart"),this._queued.push({name:a,deffered:b})},removeQueuedItem:function(a){d.log("Removing queued item for "+this.blockID+" called "+a),d.EventBus.trigger("onUploadStop"),this._queued=b.reject(this._queued,function(b){return b.name==a})},hasItemsInQueue:function(){return this._queued.length>0},resolveAllInQueue:function(){b.each(this._queued,function(a){d.log("Aborting queued request: "+a.name),a.deffered.abort()},this)}},d.BlockMixins.Controllable={mixinName:"Controllable",initializeControllable:function(){d.log("Adding controllable to block "+this.blockID),this.$control_ui=a("<div>",{"class":"st-block__control-ui"}),b.each(this.controls,function(a,c){this.addUiControl(c,b.bind(a,this))},this),this.$inner.append(this.$control_ui)},getControlTemplate:function(b){return a("<a>",{"data-icon":b,"class":"st-icon st-block-control-ui-btn st-block-control-ui-btn--"+b})},addUiControl:function(a,b){this.$control_ui.append(this.getControlTemplate(a)),this.$control_ui.on("click",".st-block-control-ui-btn--"+a,b)}},d.BlockMixins.Droppable={mixinName:"Droppable",valid_drop_file_types:["File","Files","text/plain","text/uri-list"],initializeDroppable:function(){d.log("Adding droppable to block "+this.blockID),this.drop_options=b.extend({},d.DEFAULTS.Block.drop_options,this.drop_options);var c=a(b.template(this.drop_options.html,{block:this}));this.$editor.hide(),this.$inputs.append(c),this.$dropzone=c,this.$dropzone.dropArea().bind("drop",b.bind(this._handleDrop,this)),this.$inner.addClass("st-block__inner--droppable")
},_handleDrop:function(c){c.preventDefault(),c=c.originalEvent;var e=a(c.target),f=c.dataTransfer.types;e.removeClass("st-dropzone--dragover"),!b.isUndefined(f)&&b.some(f,function(a){return b.include(this.valid_drop_file_types,a)},this)&&this.onDrop(c.dataTransfer),d.EventBus.trigger("block:content:dropped")}},d.BlockMixins.Fetchable={mixinName:"Fetchable",initializeFetchable:function(){this.withMixin(d.BlockMixins.Ajaxable)},fetch:function(c,d,e){var f=b.uniqueId(this.blockID+"_fetch"),g=a.ajax(c);return this.resetMessages(),this.addQueuedItem(f,g),b.isUndefined(d)||g.done(b.bind(d,this)),b.isUndefined(e)||g.fail(b.bind(e,this)),g.always(b.bind(this.removeQueuedItem,this,f)),g}},d.BlockMixins.Pastable={mixinName:"Pastable",initializePastable:function(){d.log("Adding pastable to block "+this.blockID),this.paste_options=b.extend({},d.DEFAULTS.Block.paste_options,this.paste_options),this.$inputs.append(b.template(this.paste_options.html,this)),this.$(".st-paste-block").bind("click",function(){a(this).select()}).bind("paste",this._handleContentPaste).bind("submit",this._handleContentPaste)}},d.BlockMixins.Uploadable={mixinName:"Uploadable",uploadsCount:0,initializeUploadable:function(){d.log("Adding uploadable to block "+this.blockID),this.withMixin(d.BlockMixins.Ajaxable),this.upload_options=b.extend({},d.DEFAULTS.Block.upload_options,this.upload_options),this.$inputs.append(b.template(this.upload_options.html,this))},uploader:function(a,b,c){return d.fileUploader(this,a,b,c)}},d.BlockPositioner=function(){var a=["<div class='st-block-positioner__inner'>","<span class='st-block-positioner__selected-value'></span>","<select class='st-block-positioner__select'></select>","</div>"].join("\n"),c=function(a,b){this.$block=a,this.instanceID=b,this.total_blocks=0,this._ensureElement(),this._bindFunctions(),this.initialize()};return b.extend(c.prototype,g,h,{bound:["onBlockCountChange","onSelectChange","toggle","show","hide"],className:"st-block-positioner",visibleClass:"st-block-positioner--is-visible",initialize:function(){this.$el.append(a),this.$select=this.$(".st-block-positioner__select"),this.$select.on("change",this.onSelectChange),d.EventBus.on(this.instanceID+":blocks:count_update",this.onBlockCountChange)},onBlockCountChange:function(a){a=this.$block.siblings(".st-block").length+1,a!=this.total_blocks&&(this.total_blocks=a,this.renderPositionList())},onSelectChange:function(){var a=this.$select.val();0!==a&&(d.EventBus.trigger(this.instanceID+":blocks:change_position",this.$block,a,1==a?"before":"after"),this.toggle())},renderPositionList:function(){for(var a="<option value='0'>"+i18n.t("general:position")+"</option>",b=1;b<=this.total_blocks;b++)a+="<option value="+b+">"+b+"</option>";this.$select.html(a)},toggle:function(){this.$select.val(0),this.$el.toggleClass(this.visibleClass)},show:function(){this.$el.addClass(this.visibleClass)},hide:function(){this.$el.removeClass(this.visibleClass)}}),c}(),d.BlockReorder=function(){var c=function(a){this.$block=a,this._ensureElement(),this._bindFunctions(),this.initialize()};return b.extend(c.prototype,g,h,{bound:["onMouseDown","onClick","onDragStart","onDragEnd","onDrag","onDrop"],className:"st-block-ui-btn st-block-ui-btn--reorder st-icon",tagName:"a",attributes:function(){return{html:"reorder",draggable:"true","data-icon":"move"}},initialize:function(){this.$el.bind("mousedown touchstart",this.onMouseDown).bind("click",this.onClick).bind("dragstart",this.onDragStart).bind("dragend touchend",this.onDragEnd).bind("drag touchmove",this.onDrag),this.$block.dropArea().bind("drop",this.onDrop)},onMouseDown:function(){d.EventBus.trigger("block:reorder:down")},onDrop:function(c){c.preventDefault(),c.stopPropagation();var e=this.$block,f=c.originalEvent.dataTransfer.getData("text/plain");if(!b.isUndefined(f)&&"st-block-"==f.substr(0,9)){var g=a("#"+f);b.isEmpty(g)||e.attr("id")==f||e.attr("data-instance")!=g.attr("data-instance")||a.contains(g[0],e[0])||e.after(g),d.EventBus.trigger("block:reorder:dropped",f)}},onDragStart:function(b){var c=a(b.currentTarget).parent();b.originalEvent.dataTransfer.setDragImage(this.$block[0],c.position().left,c.position().top),b.originalEvent.dataTransfer.setData("Text",this.$block.attr("id")),d.EventBus.trigger("block:reorder:dragstart"),this.$block.addClass("st-block--dragging")},onDragEnd:function(){d.EventBus.trigger("block:reorder:dragend"),this.$block.removeClass("st-block--dragging")},onDrag:function(){},onClick:function(){},render:function(){return this}}),c}(),d.BlockDeletion=function(){var a=function(){this._ensureElement(),this._bindFunctions()};return b.extend(a.prototype,g,h,{tagName:"a",className:"st-block-ui-btn st-block-ui-btn--delete st-icon",attributes:{html:"delete","data-icon":"bin"}}),a}();var k=function(a){var c=a.attr("data-st-name")||a.attr("name");return c||(c="Field"),b.capitalize(c)};d.BlockValidations={errors:[],valid:function(){return this.performValidations(),0===this.errors.length},performValidations:function(){this.resetErrors();var a=this.$(".st-required");b.each(a,this.validateField,this),b.each(this.validations,this.runValidator,this),this.$el.toggleClass("st-block--with-errors",this.errors.length>0)},validations:[],validateField:function(b){b=a(b);var c=b.attr("contenteditable")?b.text():b.val();0===c.length&&this.setError(b,i18n.t("errors:block_empty",{name:k(b)}))},runValidator:function(a){b.isUndefined(this[a])||this[a].call(this)},setError:function(a,b){var c=this.addMessage(b,"st-msg--error");a.addClass("st-error"),this.errors.push({field:a,reason:b,msg:c})},resetErrors:function(){b.each(this.errors,function(a){a.field.removeClass("st-error"),a.msg.remove()}),this.$messages.removeClass("st-block__messages--is-visible"),this.errors=[]}},d.BlockStore={blockStorage:{},createStore:function(a){this.blockStorage={type:b.underscored(this.type),data:a||{}}},save:function(){this.toData()},saveAndReturnData:function(){return this.save(),this.blockStorage},saveAndGetData:function(){var a=this.saveAndReturnData();return a.data||a},getData:function(){return this.blockStorage.data},setData:function(a){d.log("Setting data for block "+this.blockID),b.extend(this.blockStorage.data,a||{})},setAndRetrieveData:function(a){return this.setData(a),this.getData()},setAndLoadData:function(a){this.setData(a),this.beforeLoadingData()},toData:function(){},loadData:function(){},beforeLoadingData:function(){d.log("loadData for "+this.blockID),d.EventBus.trigger("editor/block/loadData"),this.loadData(this.getData())},_loadData:function(){d.log("_loadData is deprecated and will be removed in the future. Please use beforeLoadingData instead."),this.beforeLoadingData()},checkAndLoadData:function(){b.isEmpty(this.getData())||this.beforeLoadingData()}},d.SimpleBlock=function(){var c=function(a,c,d){this.createStore(a),this.blockID=b.uniqueId("st-block-"),this.instanceID=c,this.sirTrevor=d,this._ensureElement(),this._bindFunctions(),this.initialize.apply(this,arguments)};return b.extend(c.prototype,g,d.Events,h,d.BlockStore,{focus:function(){},valid:function(){return!0},className:"st-block",block_template:b.template("<div class='st-block__inner'><%= editor_html %></div>"),attributes:function(){return{id:this.blockID,"data-type":this.type,"data-instance":this.instanceID}},title:function(){return b.titleize(this.type.replace(/[\W_]/g," "))},blockCSSClass:function(){return this.blockCSSClass=b.to_slug(this.type),this.blockCSSClass},type:"","class":function(){return b.classify(this.type)},editorHTML:"",initialize:function(){},onBlockRender:function(){},beforeBlockRender:function(){},_setBlockInner:function(){var a=b.result(this,"editorHTML");this.$el.append(this.block_template({editor_html:a})),this.$inner=this.$el.find(".st-block__inner"),this.$inner.bind("click mouseover",function(a){a.stopPropagation()})},render:function(){return this.beforeBlockRender(),this._setBlockInner(),this._blockPrepare(),this},_blockPrepare:function(){this._initUI(),this._initMessages(),this.checkAndLoadData(),this.$el.addClass("st-item-ready"),this.on("onRender",this.onBlockRender),this.save()},_withUIComponent:function(a,b,c){this.$ui.append(a.render().$el),b&&c&&this.$ui.on("click",b,c)},_initUI:function(){var b=a("<div>",{"class":"st-block__ui"});this.$inner.append(b),this.$ui=b,this._initUIComponents()},_initMessages:function(){var b=a("<div>",{"class":"st-block__messages"});this.$inner.prepend(b),this.$messages=b},addMessage:function(b,c){var d=a("<span>",{html:b,"class":"st-msg "+c});return this.$messages.append(d).addClass("st-block__messages--is-visible"),d},resetMessages:function(){this.$messages.html("").removeClass("st-block__messages--is-visible")},_initUIComponents:function(){this._withUIComponent(new d.BlockReorder(this.$el))}}),c.fn=c.prototype,c.extend=i,c}(),d.Block=function(){var c=function(){d.SimpleBlock.apply(this,arguments)},e=["<div class='st-block__ui-delete-controls'>","<label class='st-block__delete-label'>","<%= i18n.t('general:delete') %>","</label>","<a class='st-block-ui-btn st-block-ui-btn--confirm-delete st-icon' data-icon='tick'></a>","<a class='st-block-ui-btn st-block-ui-btn--deny-delete st-icon' data-icon='close'></a>","</div>"].join("\n"),f={html:['<div class="st-block__dropzone">','<span class="st-icon"><%= _.result(block, "icon_name") %></span>','<p><%= i18n.t("general:drop", { block: "<span>" + _.result(block, "title") + "</span>" }) %>',"</p></div>"].join("\n"),re_render_on_reorder:!1},g={html:['<input type="text" placeholder="<%= i18n.t("general:paste") %>"',' class="st-block__paste-input st-paste-block">'].join("")},h={html:['<div class="st-block__upload-container">','<input type="file" type="st-file-upload">','<button class="st-upload-btn"><%= i18n.t("general:upload") %></button>',"</div>"].join("\n")};return d.DEFAULTS.Block={drop_options:f,paste_options:g,upload_options:h},b.extend(c.prototype,d.SimpleBlock.fn,d.BlockValidations,{bound:["_handleContentPaste","_onFocus","_onBlur","onDrop","onDeleteClick","clearInsertedStyles","getSelectionForFormatter","onBlockRender"],className:"st-block st-icon--add",attributes:function(){return b.extend(d.SimpleBlock.fn.attributes.call(this),{"data-icon-after":"add"})},icon_name:"default",validationFailMsg:function(){return i18n.t("errors:validation_fail",{type:b.result(this,"title")})},editorHTML:'<div class="st-block__editor"></div>',toolbarEnabled:!0,droppable:!1,pastable:!1,uploadable:!1,fetchable:!1,ajaxable:!1,drop_options:{},paste_options:{},upload_options:{},formattable:!0,_previousSelection:"",initialize:function(){},toMarkdown:function(a){return a},toHTML:function(a){return a},withMixin:function(a){if(b.isObject(a)){var c="initialize"+a.mixinName;b.isUndefined(this[c])&&(b.extend(this,a),this[c]())}},render:function(){if(this.beforeBlockRender(),this._setBlockInner(),this.$editor=this.$inner.children().first(),this.droppable||this.pastable||this.uploadable){var b=a("<div>",{"class":"st-block__inputs"});this.$inner.append(b),this.$inputs=b}return this.hasTextBlock&&this._initTextBlocks(),this.droppable&&this.withMixin(d.BlockMixins.Droppable),this.pastable&&this.withMixin(d.BlockMixins.Pastable),this.uploadable&&this.withMixin(d.BlockMixins.Uploadable),this.fetchable&&this.withMixin(d.BlockMixins.Fetchable),this.controllable&&this.withMixin(d.BlockMixins.Controllable),this.formattable&&this._initFormatting(),this._blockPrepare(),this},remove:function(){this.ajaxable&&this.resolveAllInQueue(),this.$el.remove()},loading:function(){b.isUndefined(this.spinner)||this.ready(),this.spinner=new Spinner(d.DEFAULTS.spinner),this.spinner.spin(this.$el[0]),this.$el.addClass("st--is-loading")},ready:function(){this.$el.removeClass("st--is-loading"),b.isUndefined(this.spinner)||(this.spinner.stop(),delete this.spinner)},toData:function(){d.log("toData for "+this.blockID);var a=(this.$el,{});if(this.hasTextBlock()){var c=this.getTextBlock().html();c.length>0&&(a.text=d.toMarkdown(c,this.type))}this.$(":input").not(".st-paste-block").length>0&&this.$(":input").each(function(b,c){c.getAttribute("name")&&(a[c.getAttribute("name")]=c.value)}),b.isEmpty(a)||this.setData(a)},focus:function(){this.getTextBlock().focus()},blur:function(){this.getTextBlock().blur()},onFocus:function(){this.getTextBlock().bind("focus",this._onFocus)},onBlur:function(){this.getTextBlock().bind("blur",this._onBlur)},_onFocus:function(){this.trigger("blockFocus",this.$el)},_onBlur:function(){},onDrop:function(){},onDeleteClick:function(a){a.preventDefault();var c=function(a){a.preventDefault(),this.trigger("removeBlock",this.blockID)},d=function(a){a.preventDefault(),this.$el.removeClass("st-block--delete-active"),f.remove()};if(this.isEmpty())return void c.call(this,new Event("click"));this.$inner.append(b.template(e)),this.$el.addClass("st-block--delete-active");var f=this.$inner.find(".st-block__ui-delete-controls");this.$inner.on("click",".st-block-ui-btn--confirm-delete",b.bind(c,this)).on("click",".st-block-ui-btn--deny-delete",b.bind(d,this))},pastedMarkdownToHTML:function(a){return d.toHTML(d.toMarkdown(a,this.type),this.type)},onContentPasted:function(a,b){b.html(this.pastedMarkdownToHTML(b[0].innerHTML)),this.getTextBlock().caretToEnd()},beforeLoadingData:function(){this.loading(),(this.droppable||this.uploadable||this.pastable)&&(this.$editor.show(),this.$inputs.hide()),d.SimpleBlock.fn.beforeLoadingData.call(this),this.ready()},_handleContentPaste:function(c){var d=a(c.currentTarget);b.delay(b.bind(this.onContentPasted,this,c,d),0)},_getBlockClass:function(){return"st-block--"+this.className},_initUIComponents:function(){var a=new d.BlockPositioner(this.$el,this.instanceID);this._withUIComponent(a,".st-block-ui-btn--reorder",a.toggle),this._withUIComponent(new d.BlockReorder(this.$el)),this._withUIComponent(new d.BlockDeletion,".st-block-ui-btn--delete",this.onDeleteClick),this.onFocus(),this.onBlur()},_initFormatting:function(){var a;for(var c in d.Formatters)d.Formatters.hasOwnProperty(c)&&(a=d.Formatters[c],b.isUndefined(a.keyCode)||a._bindToBlock(this.$el))},_initTextBlocks:function(){this.getTextBlock().bind("paste",this._handleContentPaste).bind("keyup",this.getSelectionForFormatter).bind("mouseup",this.getSelectionForFormatter).bind("DOMNodeInserted",this.clearInsertedStyles)},getSelectionForFormatter:function(){b.defer(function(){var a=window.getSelection(),b=a.toString().trim();d.EventBus.trigger(""===b?"formatter:hide":"formatter:position")})},clearInsertedStyles:function(a){var b=a.target;b.removeAttribute("style")},hasTextBlock:function(){return this.getTextBlock().length>0},getTextBlock:function(){return b.isUndefined(this.text_block)&&(this.text_block=this.$(".st-text-block")),this.text_block},isEmpty:function(){return b.isEmpty(this.saveAndGetData())}}),c.extend=i,c}(),d.Formatter=function(){var a=function(a){this.formatId=b.uniqueId("format-"),this._configure(a||{}),this.initialize.apply(this,arguments)},c=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];return b.extend(a.prototype,{title:"",className:"",cmd:null,keyCode:null,param:null,toMarkdown:function(a){return a},toHTML:function(a){return a},initialize:function(){},_configure:function(a){this.options&&(a=b.extend({},this.options,a));for(var d=0,e=c.length;e>d;d++){var f=c[d];a[f]&&(this[f]=a[f])}this.options=a},isActive:function(){return document.queryCommandState(this.cmd)},_bindToBlock:function(a){var b=this,c=!1;a.on("keyup",".st-text-block",function(a){(17==a.which||224==a.which||91==a.which)&&(c=!1)}).on("keydown",".st-text-block",{formatter:b},function(a){(17==a.which||224==a.which||91==a.which)&&(c=!0),a.which==a.data.formatter.keyCode&&c===!0&&(document.execCommand(a.data.formatter.cmd,!1,!0),a.preventDefault(),c=!1)})}}),a.extend=i,a}(),d.Blocks.Quote=function(){var a=b.template(['<blockquote class="st-required st-text-block" contenteditable="true"></blockquote>','<label class="st-input-label"> <%= i18n.t("blocks:quote:credit_field") %></label>','<input maxlength="140" name="cite" placeholder="<%= i18n.t("blocks:quote:credit_field") %>"',' class="st-input-string st-required js-cite-input" type="text" />'].join("\n"));return d.Block.extend({type:"quote",title:function(){return i18n.t("blocks:quote:title")},icon_name:"quote",editorHTML:function(){return a(this)},loadData:function(a){this.getTextBlock().html(d.toHTML(a.text,this.type)),this.$(".js-cite-input").val(a.cite)},toMarkdown:function(a){return a.replace(/^(.+)$/gm,"> $1")}})}(),d.Blocks.Columns=function(){return d.Block.extend({type:"Columns",title:function(){return i18n.t("blocks:columns:title")},icon_name:"columns",columns_presets:{"columns-6-6":[6,6],"columns-3-9":[3,9],"columns-9-3":[9,3],"columns-4-8":[4,8],"columns-8-4":[8,4],"columns-4-4-4":[4,4,4],"columns-3-6-3":[3,6,3],"columns-3-3-3-3":[3,3,3,3]},controllable:!0,constructor:function(){d.Block.apply(this,arguments)},beforeBlockRender:function(){this.controls={twocolumns:this.changeColumnsHandler("columns-6-6"),threecolumns:this.changeColumnsHandler("columns-4-4-4"),onetwocolumns:this.changeColumnsHandler("columns-4-8"),twoonecolumns:this.changeColumnsHandler("columns-8-4"),fourcolumns:this.changeColumnsHandler("columns-3-3-3-3"),onethreecolumns:this.changeColumnsHandler("columns-3-9"),threeonecolumns:this.changeColumnsHandler("columns-9-3"),onetwoonecolumns:this.changeColumnsHandler("columns-3-6-3")}},changeColumnsHandler:function(a){var b=this;return function(){b.changeColumns(a,!1)}},changeColumns:function(a){this.columns_preset!=a&&this.applyColumns(a)},editorHTML:function(){return b.template('<div class="columns-row" id="<%= blockID %>-columns-row" style="overflow: auto"/>',{blockID:this.blockID})},_setBlockInner:function(){d.Block.prototype._setBlockInner.apply(this,arguments),this.applyColumns("columns-6-6",!0)},applyColumns:function(c,e){var f=this,g=this.columns_presets[c],h=this.getColumns(":gt("+(g.length-1)+")");if(h.length>0){if(h.children(".st-block").length>0){var i=1==h.length?"column":h.length+" columns";if(!confirm("This action will delete last "+i+". Do you really want to proceed?"))return}h.each(function(){var b=a(this);b.children(".st-block").each(function(){f.sirTrevor.removeBlock(this.getAttribute("id"))}),b.trigger("destroy").remove()})}var j=b.reduce(g,function(a,b){return a+b},0),k=this.$(".columns-row");b.each(g,function(b,c){var e=Math.round(1e3*b*100/j)/1e3,g=f.getColumn(c);if(0==g.length){g=a('<div class="column" style="float: left; "></div>');var h=new d.FloatingBlockControls(g,f.instanceID);f.listenTo(h,"showBlockControls",f.sirTrevor.showBlockControls),g.prepend(h.render().$el),k.append(g)}g.css("width",e+"%")}),this.$(".st-block-control-ui-btn").removeClass("active").filter("[data-icon="+c+"]").addClass("active"),this.columns_preset=c,e||this.trigger("block:columns:change")},onBlockRender:function(){this.$(".st-block-control-ui-btn").filter("[data-icon="+this.columns_preset+"]").addClass("active")},getRow:function(){return this.$row?this.$row:this.$row=this.$("#"+this.blockID+"-columns-row")},getColumns:function(a){return this.getRow().children(a)},getColumn:function(a){return this.getRow().children(":eq("+a+")")},toData:function(){var b=this,c=this.columns_presets[this.columns_preset],d={columns:[],preset:this.columns_preset};this.getColumns().each(function(e){var f=[];a(this).children(".st-block").each(function(){var a=b.sirTrevor.findBlockById(this.getAttribute("id"));f.push(a.saveAndReturnData())}),d.columns.push({width:c[e],blocks:f})}),this.setData(d)},loadData:function(a){a.preset&&this.applyColumns(a.preset,!0);for(var b=a.columns||[],c=0;c<b.length;c++)for(var d=null,e=this.getColumn(c),f=0;f<b[c].blocks.length;f++){var g=b[c].blocks[f];d=this.sirTrevor.createBlock(g.type,g.data,d?d.$el:e.children(".st-block-controls__top"))}},_initUIComponents:function(){d.Block.prototype._initUIComponents.apply(this,arguments)},performValidations:function(){}})}(),d.Blocks.Heading=d.Block.extend({type:"Heading",title:function(){return i18n.t("blocks:heading:title")},editorHTML:'<div class="st-required st-text-block st-text-block--heading" contenteditable="true"></div>',icon_name:"heading",loadData:function(a){this.getTextBlock().html(d.toHTML(a.text,this.type))}}),d.Blocks.Image=d.Block.extend({type:"image",title:function(){return i18n.t("blocks:image:title")},droppable:!0,uploadable:!0,icon_name:"image",loadData:function(b){this.$editor.html(a("<img>",{src:b.file.url}))},onBlockRender:function(){this.$inputs.find("button").bind("click",function(a){a.preventDefault()}),this.$inputs.find("input").on("change",b.bind(function(a){this.onDrop(a.currentTarget)},this))},onDrop:function(b){var c=b.files[0],d="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;/image/.test(c.type)&&(this.loading(),this.$inputs.hide(),this.$editor.html(a("<img>",{src:d.createObjectURL(c)})).show(),this.uploader(c,function(a){this.setData(a),this.ready()},function(){this.addMessage(i18n.t("blocks:image:upload_error")),this.ready()}))}}),d.Blocks.Text=d.Block.extend({type:"text",title:function(){return i18n.t("blocks:text:title")},editorHTML:'<div class="st-required st-text-block" contenteditable="true"></div>',icon_name:"text",loadData:function(a){this.getTextBlock().html(d.toHTML(a.text,this.type))}}),d.Blocks.Tweet=function(){var c=b.template(["<blockquote class='twitter-tweet' align='center'>","<p><%= text %></p>","&mdash; <%= user.name %> (@<%= user.screen_name %>)","<a href='<%= status_url %>' data-datetime='<%= created_at %>'><%= created_at %></a>","</blockquote>",'<script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>'].join("\n"));return d.Block.extend({type:"tweet",droppable:!0,pastable:!0,fetchable:!0,drop_options:{re_render_on_reorder:!0},title:function(){return i18n.t("blocks:tweet:title")},fetchUrl:function(a){return"/tweets/?tweet_id="+a},icon_name:"twitter",loadData:function(a){b.isUndefined(a.status_url)&&(a.status_url=""),this.$inner.find("iframe").remove(),this.$inner.prepend(c(a))},onContentPasted:function(b){var c=a(b.target),d=c.val();this.handleTwitterDropPaste(d)},handleTwitterDropPaste:function(a){if(!this.validTweetUrl(a))return void d.log("Invalid Tweet URL");var c=a.match(/[^\/]+$/);if(!b.isEmpty(c)){this.loading(),c=c[0];var e={url:this.fetchUrl(c),dataType:"json"};this.fetch(e,this.onTweetSuccess,this.onTweetFail)}},validTweetUrl:function(a){return b.isURI(a)&&-1!==a.indexOf("twitter")&&-1!==a.indexOf("status")},onTweetSuccess:function(a){var b={user:{profile_image_url:a.user.profile_image_url,profile_image_url_https:a.user.profile_image_url_https,screen_name:a.user.screen_name,name:a.user.name},id:a.id_str,text:a.text,created_at:a.created_at,entities:a.entities,status_url:"https://twitter.com/"+a.user.screen_name+"/status/"+a.id_str};this.setAndLoadData(b),this.ready()},onTweetFail:function(){this.addMessage(i18n.t("blocks:tweet:fetch_error")),this.ready()},onDrop:function(a){var b=a.getData("text/plain");this.handleTwitterDropPaste(b)}})}(),d.Blocks.List=function(){var a='<div class="st-text-block st-required" contenteditable="true"><ul><li></li></ul></div>';return d.Block.extend({type:"list",title:function(){return i18n.t("blocks:list:title")},icon_name:"list",editorHTML:function(){return b.template(a,this)},loadData:function(a){this.getTextBlock().html("<ul>"+d.toHTML(a.text,this.type)+"</ul>")},onBlockRender:function(){this.checkForList=b.bind(this.checkForList,this),this.getTextBlock().on("click keyup",this.checkForList)},checkForList:function(){0===this.$("ul").length&&document.execCommand("insertUnorderedList",!1,!1)},toMarkdown:function(a){return a.replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1")},toHTML:function(a){return a=a.replace(/^ - (.+)$/gm,"<li>$1</li>").replace(/\n/gm,"")},onContentPasted:function(a,b){{var c=this.pastedMarkdownToHTML(b[0].innerHTML);this.$("ul").html(c)}this.getTextBlock().caretToEnd()},isEmpty:function(){return b.isEmpty(this.saveAndGetData().text)}})}(),d.Blocks.Video=function(){return d.Block.extend({providers:{vimeo:{regex:/(?:http[s]?:\/\/)?(?:www.)?vimeo.com\/(.+)/,html:'<iframe src="{{protocol}}//player.vimeo.com/video/{{remote_id}}?title=0&byline=0" width="580" height="320" frameborder="0"></iframe>'},youtube:{regex:/(?:http[s]?:\/\/)?(?:www.)?(?:(?:youtube.com\/watch\?(?:.*)(?:v=))|(?:youtu.be\/))([^&].+)/,html:'<iframe src="{{protocol}}//www.youtube.com/embed/{{remote_id}}" width="580" height="320" frameborder="0" allowfullscreen></iframe>'}},type:"video",title:function(){return i18n.t("blocks:video:title")},droppable:!0,pastable:!0,icon_name:"video",loadData:function(a){if(this.providers.hasOwnProperty(a.source)){this.$editor.addClass(this.providers[a.source].square?"st-block__editor--with-square-media":"st-block__editor--with-sixteen-by-nine-media");var b=this.providers[a.source].html.replace("{{protocol}}",window.location.protocol).replace("{{remote_id}}",a.remote_id).replace("{{width}}",this.$editor.width());this.$editor.html(b)}},onContentPasted:function(b){this.handleDropPaste(a(b.target).val())},handleDropPaste:function(a){if(b.isURI(a)){var c,d;b.each(this.providers,function(e,f){c=e.regex.exec(a),null===c||b.isUndefined(c[1])||(d={source:f,remote_id:c[1]},this.setAndLoadData(d))},this)}},onDrop:function(a){var b=a.getData("text/plain");this.handleDropPaste(b)}})}(),function(){var a=d.Formatter.extend({title:"bold",cmd:"bold",keyCode:66,text:"B"}),b=d.Formatter.extend({title:"italic",cmd:"italic",keyCode:73,text:"i"}),c=d.Formatter.extend({title:"link",iconName:"link",cmd:"CreateLink",text:"link",onClick:function(){var a=prompt(i18n.t("general:link")),b=/((ftp|http|https):\/\/.)|mailto(?=\:[-\.\w]+@)/;a&&a.length>0&&(b.test(a)||(a="http://"+a),document.execCommand(this.cmd,!1,a))},isActive:function(){var a,b=window.getSelection();return b.rangeCount>0&&(a=b.getRangeAt(0).startContainer.parentNode),a&&"A"==a.nodeName}}),e=d.Formatter.extend({title:"unlink",iconName:"link",cmd:"unlink",text:"link"});d.Formatters.Bold=new a,d.Formatters.Italic=new b,d.Formatters.Link=new c,d.Formatters.Unlink=new e}(),d.BlockControl=function(){var a=function(a,b){this.type=a,this.instance_scope=b,this.block_type=d.Blocks[this.type].prototype,this.can_be_rendered=this.block_type.toolbarEnabled,this._ensureElement()};return b.extend(a.prototype,g,h,d.Events,{tagName:"a",className:"st-block-control",attributes:function(){return{"data-type":this.block_type.type}},render:function(){return this.$el.html('<span class="st-icon">'+b.result(this.block_type,"icon_name")+"</span>"+b.result(this.block_type,"title")),this}}),a}(),d.BlockControls=function(){var c=function(a,b){this.instance_scope=b,this.available_types=a||[],this._ensureElement(),this._bindFunctions(),this.initialize()};return b.extend(c.prototype,g,h,d.Events,{bound:["handleControlButtonClick"],block_controls:null,className:"st-block-controls",html:"<a class='st-icon st-icon--close'>"+i18n.t("general:close")+"</a>",initialize:function(){for(var a in this.available_types)if(d.Blocks.hasOwnProperty(a)){var b=new d.BlockControl(a,this.instance_scope);b.can_be_rendered&&this.$el.append(b.render().$el)}this.$el.delegate(".st-block-control","click",this.handleControlButtonClick)},show:function(){this.$el.addClass("st-block-controls--active"),d.EventBus.trigger("block:controls:shown")},hide:function(){this.$el.removeClass("st-block-controls--active"),d.EventBus.trigger("block:controls:hidden")},handleControlButtonClick:function(b){b.stopPropagation(),this.trigger("createBlock",a(b.currentTarget).attr("data-type"),null,this.current_container)}}),c}(),d.FloatingBlockControls=function(){var c=function(a,b){this.$wrapper=a,this.instance_id=b,this._ensureElement(),this._bindFunctions(),this.initialize()};return b.extend(c.prototype,g,h,d.Events,{className:"st-block-controls__top",attributes:function(){return{"data-icon":"add"}},bound:["handleBlockMouseOut","handleBlockMouseOver","handleBlockClick","onDrop"],initialize:function(){this.$el.on("click",this.handleBlockClick).dropArea().bind("drop",this.onDrop),this.$wrapper.on("mouseover",".st-block",this.handleBlockMouseOver).on("mouseout",".st-block",this.handleBlockMouseOut).on("click",".st-block--with-plus",this.handleBlockClick)},onDrop:function(c){c.preventDefault(),c.stopPropagation();var e=this.$el,f=c.originalEvent.dataTransfer.getData("text/plain"),g=a("#"+f);b.isUndefined(f)||b.isEmpty(g)||e.attr("id")==f||this.instance_id!=g.attr("data-instance")||e.after(g),d.EventBus.trigger("block:reorder:dropped",f)},handleBlockMouseOver:function(b){var c=a(b.currentTarget);c.hasClass("st-block--with-plus")||c.addClass("st-block--with-plus")},handleBlockMouseOut:function(b){var c=a(b.currentTarget);c.hasClass("st-block--with-plus")&&c.removeClass("st-block--with-plus")},handleBlockClick:function(b){b.stopPropagation();var c=a(b.currentTarget);this.trigger("showBlockControls",c)}}),c}(),d.FormatBar=function(){var c=function(a){this.options=b.extend({},d.DEFAULTS.formatBar,a||{}),this._ensureElement(),this._bindFunctions(),this.initialize.apply(this,arguments)};return b.extend(c.prototype,g,d.Events,h,{className:"st-format-bar",bound:["onFormatButtonClick","renderBySelection","hide"],initialize:function(){var b,c,e;this.$btns=[];for(b in d.Formatters)d.Formatters.hasOwnProperty(b)&&(c=d.Formatters[b],e=a("<button>",{"class":"st-format-btn st-format-btn--"+b+" "+(c.iconName?"st-icon":""),text:c.text,"data-type":b,"data-cmd":c.cmd}),this.$btns.push(e),e.appendTo(this.$el));this.$b=a(document),this.$el.bind("click",".st-format-btn",this.onFormatButtonClick)},hide:function(){this.$el.removeClass("st-format-bar--is-ready")},show:function(){this.$el.addClass("st-format-bar--is-ready")},remove:function(){this.$el.remove()},renderBySelection:function(){var a=window.getSelection(),b=a.getRangeAt(0),c=b.getBoundingClientRect(),d={};d.top=c.top+20+window.pageYOffset-this.$el.height()+"px",d.left=(c.left+c.right)/2-this.$el.width()/2+"px",this.highlightSelectedButtons(),this.show(),this.$el.css(d)},highlightSelectedButtons:function(){var a;b.each(this.$btns,function(b){a=d.Formatters[b.attr("data-type")],b.toggleClass("st-format-btn--is-active",a.isActive())},this)},onFormatButtonClick:function(c){c.stopPropagation();var e=a(c.target),f=d.Formatters[e.attr("data-type")];return b.isUndefined(f)?!1:(!b.isUndefined(f.onClick)&&b.isFunction(f.onClick)?f.onClick():document.execCommand(e.attr("data-cmd"),!1,f.param),this.highlightSelectedButtons(),!1)}}),c}(),d.Editor=function(){var e=function(a){this.initialize(a)};return b.extend(e.prototype,g,d.Events,{bound:["onFormSubmit","showBlockControls","hideAllTheThings","hideBlockControls","onNewBlockCreated","changeBlockPosition","onBlockDragStart","onBlockDragEnd","removeBlockDragOver","onBlockDropped","createBlock"],events:{"block:reorder:down":"hideBlockControls","block:reorder:dragstart":"onBlockDragStart","block:reorder:dragend":"onBlockDragEnd","block:content:dropped":"removeBlockDragOver","block:reorder:dropped":"onBlockDropped","block:create:new":"onNewBlockCreated"},initialize:function(a){return d.log("Init SirTrevor.Editor"),this.blockTypes={},this.blockCounts={},this.blocks=[],this.errors=[],this.options=b.extend({},d.DEFAULTS,a||{}),this.ID=b.uniqueId("st-editor-"),this._ensureAndSetElements()?(!b.isUndefined(this.options.onEditorRender)&&b.isFunction(this.options.onEditorRender)&&(this.onEditorRender=this.options.onEditorRender),this._setRequired(),this._setBlocksTypes(),this._bindFunctions(),this.store("create"),d.instances.push(this),this.build(),void d.bindFormSubmit(this.$form)):!1},build:function(){this.$el.hide(),this.block_controls=new d.BlockControls(this.blockTypes,this.ID),this.fl_block_controls=new d.FloatingBlockControls(this.$wrapper,this.ID,this),this.formatBar=new d.FormatBar(this.options.formatBar),this.listenTo(this.block_controls,"createBlock",this.createBlock),this.listenTo(this.fl_block_controls,"showBlockControls",this.showBlockControls),this._setEvents(),d.EventBus.on(this.ID+":blocks:change_position",this.changeBlockPosition),d.EventBus.on("formatter:position",this.formatBar.renderBySelection),d.EventBus.on("formatter:hide",this.formatBar.hide),this.$wrapper.prepend(this.fl_block_controls.render().$el),a(document.body).append(this.formatBar.render().$el),this.$outer.append(this.block_controls.render().$el),a(window).bind("click",this.hideAllTheThings);
var c=this.store("read");c.data.length>0?b.each(c.data,function(a){d.log("Creating: "+a.type),this.createBlock(a.type,a.data)},this):this.options.defaultType!==!1&&this.createBlock(this.options.defaultType,{}),this.$wrapper.addClass("st-ready"),b.isUndefined(this.onEditorRender)||this.onEditorRender()},destroy:function(){this.formatBar.destroy(),this.fl_block_controls.destroy(),this.block_controls.destroy(),b.each(this.$wrapper.children(".st-block"),function(a){this.removeBlock(a.id)},this),this.stopListening(),d.unbindFormSubmit(this.$form);var a=this.$el.detach();d.instances=b.reject(d.instances,b.bind(function(a){return a.ID==this.ID},this)),this.store("reset"),this.$outer.replaceWith(a)},reinitialize:function(a){this.destroy(),this.initialize(a||this.options)},_setEvents:function(){b.each(this.events,function(a,b){d.EventBus.on(b,this[a],this)},this)},hideAllTheThings:function(){this.block_controls.hide(),this.formatBar.hide(),b.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls")},showBlockControls:function(a){b.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls"),this.block_controls.show(),a.append(this.block_controls.$el.detach()),a.addClass("with-st-controls"),this.block_controls.current_container=a},store:function(a,b){return d.editorStore(this,a,b||{})},createBlock:function(a,c,e){if(a=b.classify(a),this._blockLimitReached())return d.log("Cannot add any more blocks. Limit reached."),!1;if(!this._isBlockTypeAvailable(a))return d.log("Block type not available "+a),!1;if(!this._canAddBlockType(a))return d.log("Block Limit reached for type "+a),!1;var f=new d.Blocks[a](c,this.ID,this);return this._renderInPosition(f.render().$el,e),this.listenTo(f,"removeBlock",this.removeBlock),this.blocks.push(f),this._incrementBlockTypeCount(a),f.focus(),d.EventBus.trigger(c?"block:create:existing":"block:create:new",f),d.log("Block created of type "+a),f.trigger("onRender"),this.$wrapper.toggleClass("st--block-limit-reached",this._blockLimitReached()),this.triggerBlockCountUpdate(),f},onNewBlockCreated:function(a){this.hideBlockControls(),this.scrollTo(a.$el)},scrollTo:function(b){a("html, body").animate({scrollTop:b.offset().top},300,"linear")},blockFocus:function(){this.block_controls.current_container=null},hideBlockControls:function(){b.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls"),this.block_controls.hide()},removeBlockDragOver:function(){this.$outer.find(".st-drag-over").removeClass("st-drag-over")},triggerBlockCountUpdate:function(){d.EventBus.trigger(this.ID+":blocks:count_update",this.blocks.length)},changeBlockPosition:function(a,b){b-=1;var c=this.getBlockPosition(a),d=a.parent().children(".st-block").eq(b),e=c>b?"Before":"After";d&&d.attr("id")!==a.attr("id")&&(this.hideAllTheThings(),a["insert"+e](d),this.scrollTo(a))},onBlockDropped:function(a){this.hideAllTheThings();var c=this.findBlockById(a);b.isUndefined(c)||b.isEmpty(c.getData())||!c.drop_options.re_render_on_reorder||c.beforeLoadingData()},onBlockDragStart:function(){this.hideBlockControls(),this.$wrapper.addClass("st-outer--is-reordering")},onBlockDragEnd:function(){this.removeBlockDragOver(),this.$wrapper.removeClass("st-outer--is-reordering")},_renderInPosition:function(a,c){b.isUndefined(c)?this.$wrapper.append(a):c.after(a)},_incrementBlockTypeCount:function(a){this.blockCounts[a]=b.isUndefined(this.blockCounts[a])?1:this.blockCounts[a]+1},_getBlockTypeCount:function(a){return b.isUndefined(this.blockCounts[a])?0:this.blockCounts[a]},_canAddBlockType:function(a){var b=this._getBlockTypeLimit(a);return!(0!==b&&this._getBlockTypeCount(a)>=b)},_blockLimitReached:function(){return 0!==this.options.blockLimit&&this.blocks.length>=this.options.blockLimit},removeBlock:function(c){var e=this.findBlockById(c),f=b.classify(e.type),g=e.$el.find(".st-block-controls"),h=e.$el.find(".st-block");if(h.length>0){var i=h.map(function(){return{depth:a(this).parents().length,id:this.getAttribute("id")}}).get();i.sort(function(a,b){return a.depth-b.depth});for(var j=0;j<i.length;j++)this.removeBlock(i[j].id)}g.length&&(this.block_controls.hide(),this.$wrapper.prepend(g)),this.blockCounts[f]=this.blockCounts[f]-1,this.blocks=b.reject(this.blocks,function(a){return a.blockID==e.blockID}),this.stopListening(e),d.EventBus.trigger("block:remove:pre",e),e.remove(),d.EventBus.trigger("block:remove",e),this.triggerBlockCountUpdate(),this.$wrapper.toggleClass("st--block-limit-reached",this._blockLimitReached())},performValidations:function(a,c){var e=0;return!d.SKIP_VALIDATION&&c&&(a.valid()||(this.errors.push({text:b.result(a,"validationFailMsg")}),d.log("Block "+a.blockID+" failed validation"),++e)),e},saveBlockStateToStore:function(a){var c=a.saveAndReturnData();c&&!b.isEmpty(c.data)&&(d.log("Adding data for block "+a.blockID+" to block store"),this.store("add",{data:c}))},onFormSubmit:function(a){return a=a===!1?!1:!0,d.log("Handling form submission for Editor "+this.ID),this.removeErrors(),this.store("reset"),this.validateBlocks(a),this.validateBlockTypesExist(a),this.renderErrors(),this.store("save"),this.errors.length},validateBlocks:function(c){var d=function(d){var e=b.find(this.blocks,function(b){return b.blockID==a(d).attr("id")});return b.isUndefined(e)?!1:(this.performValidations(e,c),void(this.$wrapper.children().filter(d).length>0&&this.saveBlockStateToStore(e)))};b.each(this.$wrapper.find(".st-block"),d,this)},validateBlockTypesExist:function(a){if(!this.required&&d.SKIP_VALIDATION&&!a)return!1;var c=function(a){if(this._isBlockTypeAvailable(a))if(0===this._getBlockTypeCount(a))d.log("Failed validation on required block type "+a),this.errors.push({text:i18n.t("errors:type_missing",{type:a})});else{var c=b.filter(this.getBlocksByType(a),function(a){return!a.isEmpty()});if(c.length>0)return!1;this.errors.push({text:i18n.t("errors:required_type_empty",{type:a})}),d.log("A required block type "+a+" is empty")}};b.isArray(this.required)&&b.each(this.required,c,this)},renderErrors:function(){if(0===this.errors.length)return!1;b.isUndefined(this.$errors)&&(this.$errors=this._errorsContainer());var a="<ul>";b.each(this.errors,function(b){a+='<li class="st-errors__msg">'+b.text+"</li>"}),a+="</ul>",this.$errors.append(a),this.$errors.show()},_errorsContainer:function(){if(b.isUndefined(this.options.errorsContainer)){var d=a("<div>",{"class":"st-errors",html:"<p>"+i18n.t("errors:title")+" </p>"});return this.$outer.prepend(d),d}return c(this.options.errorsContainer)},removeErrors:function(){return 0===this.errors.length?!1:(this.$errors.hide().find("ul").html(""),void(this.errors=[]))},findBlockById:function(a){return b.find(this.blocks,function(b){return b.blockID==a})},getBlocksByType:function(a){return b.filter(this.blocks,function(c){return b.classify(c.type)==a})},getBlocksByIDs:function(a){return b.filter(this.blocks,function(c){return b.contains(a,c.blockID)})},getBlockPosition:function(a){return a.parent().children(".st-block").index(a)},_getBlockTypeLimit:function(a){return this._isBlockTypeAvailable(a)?parseInt(b.isUndefined(this.options.blockTypeLimits[a])?0:this.options.blockTypeLimits[a],10):0},_isBlockTypeAvailable:function(a){return!b.isUndefined(this.blockTypes[a])},_ensureAndSetElements:function(){if(b.isUndefined(this.options.el)||b.isEmpty(this.options.el))return d.log("You must provide an el"),!1;this.$el=this.options.el,this.el=this.options.el[0],this.$form=this.$el.parents("form");var c=a("<div>").attr({id:this.ID,"class":"st-outer",dropzone:"copy link move"}),e=a("<div>").attr({"class":"st-blocks"});return this.$el.wrap(c).wrap(e),this.$outer=this.$form.find("#"+this.ID),this.$wrapper=this.$outer.find(".st-blocks"),!0},_setBlocksTypes:function(){this.blockTypes=b.flattern(b.isUndefined(this.options.blockTypes)?d.Blocks:this.options.blockTypes)},_setRequired:function(){this.required=b.isArray(this.options.required)&&!b.isEmpty(this.options.required)?this.options.required:!1}}),e}(),d.setDefaults=function(a){d.DEFAULTS=b.extend(d.DEFAULTS,a||{})},d.bindFormSubmit=function(a){f||(new d.Submittable(a),a.bind("submit",this.onFormSubmit),f=!0)},d.unbindFormSubmit=function(a){f&&(a.unbind("submit",this.onFormSubmit),f=!1)},d.onBeforeSubmit=function(a){var c=0;return b.each(d.instances,function(b){c+=b.onFormSubmit(a)}),d.log("Total errors: "+c),c},d.onFormSubmit=function(a){var b=d.onBeforeSubmit();b>0&&(d.EventBus.trigger("onError"),a.preventDefault())},d.getInstance=function(a){return b.isUndefined(a)?this.instances[0]:b.isString(a)?b.find(this.instances,function(b){return b.ID===a}):this.instances[a]},d.setBlockOptions=function(a,c){var e=d.Blocks[a];b.isUndefined(e)||b.extend(e.prototype,c||{})},d.runOnAllInstances=function(a){b.has(d.Editor.prototype,a)?([].unshift.call(arguments,d.instances),b.invoke.apply(b,arguments)):d.log("method doesn't exist")}}(jQuery,_);